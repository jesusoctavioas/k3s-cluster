---
- name: Cluster Reset
  hosts: cluster
  become: true
  gather_facts: true
  serial:
    - 3
    - 5
  vars_prompt:
    - name: prompt_remove_packages
      prompt: Remove installed apt packages? [Y/n]
      default: 'n'
      private: false
  tasks:
    - name: Reset cluster
      ansible.builtin.include_role:
        name: '{{ cluster_item }}'
        tasks_from: reset
      loop:
        - cluster
        - k3s
      loop_control:
        loop_var: cluster_item

    - name: Get packages information
      ansible.builtin.package_facts:

    - name: Reset kubernetes charts and dependencies
      ansible.builtin.include_role:
        name: '{{ kubernetes_item }}'
        tasks_from: reset
      loop:
        - argocd
        - certmanager
        - cilium
        - longhorn
        - prometheus
        - sealedsecrets
        - helm
      loop_control:
        loop_var: kubernetes_item
