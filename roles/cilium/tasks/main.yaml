---
- name: Import facts
  ansible.builtin.import_role:
    name: common
    tasks_from: facts

- name: Download archive
  ansible.builtin.get_url:
    url: https://github.com/cilium/{{ item[0] }}/releases/download/{{ item[1] }}/{{ item[2] }}-linux-arm.tar.gz
    checksum: sha256:https://github.com/cilium/{{ item[0] }}/releases/download/{{ item[1] }}/{{ item[2] }}-linux-arm.tar.gz.sha256sum
    dest: /tmp
    owner: root
    group: root
    mode: 0644
  loop:
    - ['cilium-cli', '{{ cilium_version }}', 'cilium']
    - ['hubble', '{{ hubble_version }}', 'hubble']
  notify: Install binary

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Delete archive
  ansible.builtin.file:
    path: /tmp/{{ item }}-linux-arm.tar.gz
    state: absent
  loop:
    - cilium
    - hubble

- name: Add repository
  kubernetes.core.helm_repository:
    name: cilium
    repo_state: present
    repo_url: https://helm.cilium.io

- name: Install chart
  kubernetes.core.helm:
    chart_ref: cilium/cilium
    chart_version: "{{ cilium_chart_version }}"
    kubeconfig: "{{ k3s_conf_dir }}/k3s.yaml"
    name: cilium
    namespace: kube-system
    update_repo_cache: true
    values:
      hubble:
        relay:
          enabled: true
        ui:
          enabled: true
          service:
            type: NodePort
      l7Proxy: false
      operator:
        replicas: 1
    wait: true
  when: ansible_host == k3s_host
