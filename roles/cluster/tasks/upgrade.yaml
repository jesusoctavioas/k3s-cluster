---
- name: Upgrade distribution packages
  ansible.builtin.apt:
    state: fixed
    upgrade: dist
    autoremove: true
    update_cache: true

- name: Update bootloader firmware
  ansible.builtin.command:
    cmd: rpi-eeprom-update -ad
  changed_when: command.stdout.find('updates pending') != -1
  notify: Reboot
  register: command

- name: Check reboot status
  ansible.builtin.stat:
    path: /var/run/reboot-required
    get_checksum: false
  changed_when: reboot.stat.exists
  notify: Reboot
  register: reboot

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
