---
- name: Import facts
  ansible.builtin.import_role:
    name: k3s
    tasks_from: facts

- name: Remove Dependencies
  when: ansible_host in k3s_server_hosts
  block:
    - name: Remove plugin
      kubernetes.core.helm_plugin:
        plugin_name: diff
        state: absent

    - name: Remove Packages
      when: remove_packages in ['y', 'Y']
      block:
        - name: Remove packages
          ansible.builtin.apt:
            name: '{{ item }}'
            state: absent
            autoremove: true
          loop:
            - apt-transport-https
            - git
            - helm
            - python3-debian
            - python3-kubernetes

        - name: Remove files
          ansible.builtin.file:
            name: '{{ item }}'
            state: absent
          loop:
            - /etc/apt/sources.list.d/helm-stable.sources
            - /usr/share/keyrings/helm-archive-stable.gpg
