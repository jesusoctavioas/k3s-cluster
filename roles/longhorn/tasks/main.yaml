---
- name: Import facts
  ansible.builtin.import_role:
    name: k3s
    tasks_from: facts

- name: Add repository
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
  when: ansible_host in k3s_server_hosts

- name: Chart Setup
  when: ansible_host == k3s_server_default_host
  block:
    - name: Install tainted chart
      kubernetes.core.helm:
        chart_ref: longhorn/longhorn
        chart_version: '{{ longhorn_vars.version.chart }}'
        kubeconfig: '{{ k3s_vars.directory.config }}/k3s.yaml'
        name: longhorn
        namespace: kube-system
        update_repo_cache: true
        values:
          defaultSettings:
            nodeDownPodDeletionPolicy: '{{ longhorn_vars.pod.deletion_policy }}'
            taintToleration: node-role.kubernetes.io/master=true:NoSchedule
          longhornDriver:
            tolerations:
              - key: node-role.kubernetes.io/master
                operator: Equal
                value: 'true'
                effect: NoSchedule
          longhornManager:
            tolerations:
              - key: node-role.kubernetes.io/master
                operator: Equal
                value: 'true'
                effect: NoSchedule
        wait: true
      when: k3s_vars.controlplane.tainted

    - name: Install non-tainted chart
      kubernetes.core.helm:
        chart_ref: longhorn/longhorn
        chart_version: '{{ longhorn_vars.version.chart }}'
        kubeconfig: '{{ k3s_vars.directory.config }}/k3s.yaml'
        name: longhorn
        namespace: kube-system
        update_repo_cache: true
        values:
          defaultSettings:
            nodeDownPodDeletionPolicy: '{{ longhorn_vars.pod.deletion_policy }}'
        wait: true
      when: not k3s_vars.controlplane.tainted

    - name: Configure frontend
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            annotations:
              io.cilium/lb-ipam-ips: '{{ longhorn_vars.loadbalancer.ip.frontend }}'
              io.cilium/lb-ipam-sharing-key: longhorn-frontend
            name: longhorn-frontend
            namespace: kube-system
          spec:
            selector:
              app: longhorn-ui
            type: LoadBalancer
        kubeconfig: '{{ k3s_vars.directory.config }}/k3s.yaml'
