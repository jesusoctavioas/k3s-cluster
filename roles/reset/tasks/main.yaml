---
- name: Disable services
  ansible.builtin.systemd:
    name: '{{ item }}'
    state: stopped
    enabled: false
  with_items:
    - k3s
    - k3s-node

- name: Kill running shims
  ansible.builtin.command: pkill -9 -f "k3s/data/[^/]+/bin/containerd-shim-runc"
  changed_when: pkill.rc == 0
  register: pkill

- name: Umount k3s filesystems
  ansible.builtin.include_tasks: umount.yaml
  with_items:
    - /run/k3s
    - /var/lib/kubelet
    - /run/netns
    - '{{ k3s_data_dir }}'
  loop_control:
    loop_var: mounted_fs

- name: Remove service files, binaries and data
  ansible.builtin.file:
    name: '{{ item }}'
    state: absent
  with_items:
    - '{{ k3s_config_dir }}'
    - '{{ k3s_data_dir }}'
    - /etc/systemd/system/k3s.service
    - /etc/systemd/system/k3s-node.service
    - /usr/local/bin/k3s
    - /var/lib/kubelet

- name: Daemon reload
  ansible.builtin.systemd:
    daemon_reload: true
